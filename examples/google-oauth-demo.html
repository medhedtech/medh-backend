<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEDH - Google OAuth Demo</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        
        .oauth-section {
            margin: 30px 0;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            background: #fafafa;
        }
        
        .oauth-section h3 {
            color: #444;
            margin-bottom: 15px;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            margin: 10px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .btn-google {
            background: #db4437;
            color: white;
            box-shadow: 0 4px 15px rgba(219, 68, 55, 0.3);
        }
        
        .btn-google:hover {
            background: #c23321;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(219, 68, 55, 0.4);
        }
        
        .btn-test {
            background: #4285f4;
            color: white;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }
        
        .btn-test:hover {
            background: #3367d6;
            transform: translateY(-2px);
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .user-info {
            margin: 20px 0;
            padding: 20px;
            background: #e8f5e8;
            border-radius: 8px;
            text-align: left;
        }
        
        .user-info h4 {
            margin-top: 0;
            color: #2d5a2d;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            text-align: left;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .endpoints {
            text-align: left;
            margin: 20px 0;
        }
        
        .endpoint {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .google-signin-btn {
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ MEDH Google OAuth Demo</h1>
        <p class="subtitle">Test your Google OAuth sign-up implementation</p>
        
        <!-- Status Display -->
        <div id="status" class="status" style="display: none;"></div>
        
        <!-- Method 1: Server-Side OAuth (Redirect) -->
        <div class="oauth-section">
            <h3>üîÑ Method 1: Server-Side OAuth (Redirect)</h3>
            <p>Traditional OAuth flow with server-side redirect</p>
            <a href="http://localhost:8080/api/v1/auth/oauth/google" class="btn btn-google">
                üîë Sign in with Google (Redirect)
            </a>
        </div>
        
        <!-- Method 2: Frontend OAuth (Recommended) -->
        <div class="oauth-section">
            <h3>‚ö° Method 2: Frontend OAuth (Recommended)</h3>
            <p>Modern OAuth flow with frontend control</p>
            
            <!-- Google Identity Services Button -->
            <div id="google-signin-btn" class="google-signin-btn"></div>
            
            <!-- Manual Frontend OAuth Button -->
            <button id="frontend-oauth-btn" class="btn btn-google" onclick="handleFrontendOAuth()">
                <span id="frontend-loading" style="display: none;" class="loading"></span>
                üåü Frontend OAuth Sign-in
            </button>
        </div>
        
        <!-- Test Endpoints -->
        <div class="oauth-section">
            <h3>üß™ Test Endpoints</h3>
            <button class="btn btn-test" onclick="testProviders()">Test OAuth Providers</button>
            <button class="btn btn-test" onclick="testConnectedProviders()">Test Connected Providers</button>
        </div>
        
        <!-- User Information Display -->
        <div id="user-info" class="user-info" style="display: none;">
            <h4>‚úÖ OAuth Success - User Information:</h4>
            <pre id="user-data"></pre>
        </div>
        
        <!-- Available Endpoints -->
        <div class="oauth-section">
            <h3>üì° Available OAuth Endpoints</h3>
            <div class="endpoints">
                <div class="endpoint">GET /api/v1/auth/oauth/providers - Get available providers</div>
                <div class="endpoint">GET /api/v1/auth/oauth/google - Initiate Google OAuth</div>
                <div class="endpoint">POST /api/v1/auth/oauth/frontend - Frontend OAuth</div>
                <div class="endpoint">GET /api/v1/auth/oauth/connected - Get connected providers</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const BACKEND_URL = 'http://localhost:8080';
        const GOOGLE_CLIENT_ID = '336196538465-vrr3skl6af67eohr0u5drhpr21kqagol.apps.googleusercontent.com';
        
        // Initialize Google Identity Services
        window.onload = function() {
            if (typeof google !== 'undefined') {
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleGoogleIdentityResponse,
                    auto_select: false,
                    cancel_on_tap_outside: false
                });
                
                google.accounts.id.renderButton(
                    document.getElementById('google-signin-btn'),
                    {
                        theme: 'outline',
                        size: 'large',
                        text: 'signin_with',
                        shape: 'rectangular',
                        logo_alignment: 'left',
                        width: '300'
                    }
                );
            }
            
            // Check URL parameters for OAuth callback
            checkOAuthCallback();
        };
        
        // Handle Google Identity Services response
        async function handleGoogleIdentityResponse(response) {
            showStatus('Processing Google OAuth...', 'info');
            
            try {
                const backendResponse = await fetch(`${BACKEND_URL}/api/v1/auth/oauth/frontend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        provider: 'google',
                        token: response.credential
                    }),
                });

                const result = await backendResponse.json();

                if (result.success) {
                    // Store tokens
                    localStorage.setItem('access_token', result.data.tokens.access_token);
                    localStorage.setItem('refresh_token', result.data.tokens.refresh_token);
                    
                    showStatus('‚úÖ OAuth successful! User logged in.', 'success');
                    displayUserInfo(result.data);
                } else {
                    showStatus(`‚ùå OAuth failed: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('OAuth error:', error);
                showStatus(`‚ùå OAuth error: ${error.message}`, 'error');
            }
        }
        
        // Handle frontend OAuth with manual token
        async function handleFrontendOAuth() {
            const loadingEl = document.getElementById('frontend-loading');
            const btnText = document.querySelector('#frontend-oauth-btn');
            
            loadingEl.style.display = 'inline-block';
            btnText.disabled = true;
            
            showStatus('Initiating frontend OAuth...', 'info');
            
            try {
                // For demo purposes, we'll use Google Identity Services
                if (typeof google !== 'undefined') {
                    google.accounts.id.prompt();
                } else {
                    showStatus('‚ùå Google Identity Services not loaded', 'error');
                }
            } catch (error) {
                console.error('Frontend OAuth error:', error);
                showStatus(`‚ùå Frontend OAuth error: ${error.message}`, 'error');
            } finally {
                loadingEl.style.display = 'none';
                btnText.disabled = false;
            }
        }
        
        // Test OAuth providers endpoint
        async function testProviders() {
            showStatus('Testing OAuth providers...', 'info');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/v1/auth/oauth/providers`);
                const result = await response.json();
                
                if (result.success) {
                    showStatus(`‚úÖ Found ${result.data.total_providers} OAuth providers`, 'success');
                    console.log('OAuth Providers:', result.data);
                } else {
                    showStatus(`‚ùå Failed to get providers: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Error testing providers: ${error.message}`, 'error');
            }
        }
        
        // Test connected providers (requires authentication)
        async function testConnectedProviders() {
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                showStatus('‚ùå Please login first to test connected providers', 'error');
                return;
            }
            
            showStatus('Testing connected providers...', 'info');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/v1/auth/oauth/connected`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(`‚úÖ Connected providers: ${result.data.total_connected}`, 'success');
                    console.log('Connected Providers:', result.data);
                } else {
                    showStatus(`‚ùå Failed to get connected providers: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Error testing connected providers: ${error.message}`, 'error');
            }
        }
        
        // Check for OAuth callback parameters
        function checkOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const error = urlParams.get('error');
            const success = urlParams.get('success');
            
            if (token) {
                localStorage.setItem('access_token', token);
                showStatus('‚úÖ OAuth callback successful! Token stored.', 'success');
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (error) {
                showStatus(`‚ùå OAuth callback error: ${error}`, 'error');
            } else if (success === 'true') {
                showStatus('‚úÖ OAuth flow completed successfully!', 'success');
            }
        }
        
        // Show status message
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            // Auto-hide after 10 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 10000);
            }
        }
        
        // Display user information
        function displayUserInfo(data) {
            const userInfoEl = document.getElementById('user-info');
            const userDataEl = document.getElementById('user-data');
            
            userDataEl.textContent = JSON.stringify(data, null, 2);
            userInfoEl.style.display = 'block';
        }
        
        // Clear stored tokens (for testing)
        function clearTokens() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            showStatus('üóëÔ∏è Tokens cleared', 'info');
            document.getElementById('user-info').style.display = 'none';
        }
        
        // Add clear tokens button
        document.addEventListener('DOMContentLoaded', function() {
            const clearBtn = document.createElement('button');
            clearBtn.textContent = 'üóëÔ∏è Clear Tokens';
            clearBtn.className = 'btn btn-test';
            clearBtn.onclick = clearTokens;
            clearBtn.style.background = '#dc3545';
            clearBtn.style.marginTop = '20px';
            
            document.querySelector('.container').appendChild(clearBtn);
        });
    </script>
</body>
</html> 